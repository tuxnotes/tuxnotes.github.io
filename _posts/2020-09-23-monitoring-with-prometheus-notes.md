---
layout: post
title: monitoring with pormetheus
date: 2020-09-23
author: tux
tags: prometheus
---
# 1 监控简介

## 1.1 什么是监控

从技术角度看，监控是衡量和管理技术系统的工具和流程。监控将系统和应用程序生产的
指标转换为对应的业务价值。将指标转化为衡量用户体验的依据，该依据为业务提供反馈，以确保为客户提供了所需的产品。同时还提供了对技术的反馈，指出哪些组件不起作用或
导致服务质量下降。

实际上监控系统有如下两个“客户”:

- 技术
- 业务

### 1.1.1 技术作为客户

监控系统的第一个客户是技术，是运维工程师、devops或是SRE需要面对的。通过监控系统
了解技术环境，帮助检测、诊断和解决技术环境中的故障和问题。

Google SRE手册中有一个很棒的图标，显示了监控是构建和管理应用程序层次结构的基础。

### 1.1.2 业务作为客户

监控系统是为了支持业务，并确保业务持续开展。监控可以提供报告，是企业能进行良好的
产品和技术投资。还有助于企业衡量技术带来的价值。

## 1.2 监控基础知识

监控是管理机车设施和业务的核心工具。监控也是必须的，应该和应用程序一起构建和部署。

- 事后监控：监控与安全性一样，也是应用程序的核心功能。务必把应用程序的每个组件的监控指标考虑进来，千万不能等到项目结束或部署之前再做这件事。
- 机械式监控：常见的例子是只监控每台主机上的基础资源，二不监控主机上应用程序是否正常运行的关键服务。
- 不够准确的监控：如通过检查HTTP 200状态码来确定程序是否正常运行，这种方式只会告诉你应用程序正在响应请求，但不会反映出是否返回来正确但数据。因此要监控食物但内容和速率，二不是监控它运行但web服务器但运行时间
- 静态监控：使用静态阈值。为了更好地监控，需要查看数据窗口，而不是静态但时间点，需要使用只能但技术来分析指标和阈值
- 不频繁但监控：设置监控周期是一项挑战，但需要牢记但是存储足够多但历史数据可以有效地识别性能但问题和趋势。
- 缺少自动化或自服务：监控系统但实施和部署应尽可能但自动化

**良好的监控系统应能提供以下内容**：

- 全局视角，从最高曾（业务）依次展开。
- 协助故障诊断
- 作为基础设施、应用程序开发和业务人员的信息源
- 内置于应用程序设计、开发和部署的生命周期中
- 尽可能自动化， 并提供自服务

## 1.3 监控机制

### 1.3.1 探针和内省

监控应用程序主要有两种方法：探针(probing)和内省(introspection)。

**探针**:在应用程序外部，查询应用程序的外部特征：监听端口是否有响应并返回正确的数据或状态码。探针监控的一个例子是执行ICMP检查并确认可以收到响应。Nagios就是一个主要基于探针监控的监控系统。

**内省监控**：查看应用程序内部的内容。应用程序经过检测，并返回其状态、内部组件，或事物和四件性能的量度。这些数据可准确显示应用程序的运行方式，而不仅是其可用性或表面行为。内省监控可直接将事件、日志和指标发送到监控工具，也可将信息发送给状态或健康检查接口，然后由监控工具收集。

### 1.3.2 拉取和推送

pull和push两种方法各有利弊。Prometheus主要是基于拉取第监控系统，但也支持接受推送到网关到事件。

### 1.3.3 监控数据类型

- 指标：指标存储为时间序列数据，用于记录应用程序度量的状态.Prometheus主要关注收集时间序列数据。
- 日志：日志是应用程序发出的事件(通常是文本)。日志有助于故障诊断和调查。

## 1.4 指标

指标似乎始终是任何监控体系结构中最直接的部分。然后我们有时并没有投入足够的时间去理解指标，为什么收集，以及对指标做了什么。
许多监控框架的重点是故障检测，即检测是否发生了特定的系统事件或处于什么状态(这是Nagios的风格)。当收到特定系统事件的通知时，
才会查看收集到的指标，以找出发生的确切情况及原因。这个思路，指标被是为故障检测的副产品或者补充。

Prometheus改变了"指标作为补充"的观念，指标变成了监控工作流程中最重要的部分。Prometheus颠覆了以故障检测为中心的模型，指标
用来反映环境的状态、可用性以及性能。

### 1.4.1 什么是指标

指标是软件或硬件组件属性的量度。为了是指标有价值，我们会跟踪其状态，通常记录一段时间内的数据点。这些数据点称为观察点(observation)。观察点通常包括值、时间戳，有时也涵盖描述观察点的一系列属性(如源或标签)。观察的集合称为时间序列。

时间序列数据的典型示例是网站的访问或点击。定期收集有关网站点击量的观察点，记录点击次数和查看次数。还可能收集如访问来源、被访问
到的服务器或其他各种信息等的属性。

通常以固定的时间间隔收集数据，该时间间隔称为颗粒度（granularity）或分辨率(resolution),取值可以从1秒到5分钟，甚至更长。正确的
选择指标的可路堵至关重要，颗粒度太粗，则容易错过细节。颗粒度太细，则需要存储和分析大量数据。

### 1.4.2 指标类型

#### 测量型

测量型(gauge),这种类型是上下增减的数字，本质上是特定度量的快照。常见的监控指标如CPU、内存和磁盘使用率等都属于这个类型。对于
业务指标来说，指标可能是网站上的客户数量。

#### 计数型

计数型(counter)，这种类型岁时间增加而不会减少的数字。永远不会减少，但有时可以将其重置为零并再次开始递增。应用成俗和基础设施
的计数型示例包括系统正常的运行时间、设备收发包的字节数或登录次数。业务方面的示例可能是一个月内的销售数量或应用程序收到的订单
数量。

计数型指标的一个优势在于可以让你计算变化率。通过变化率可以理解许多有用的信息。如登录次数指标，通过计算变化率来查看每秒的登录
次数，有助于确定网站这段时间的受欢迎程度。

#### 直方图

直方图(histogram)是对观察点进行采样的指标类型，可以展现数据集的频率分布。将数据分组在一起并以这样的方式显示，这个被称为
"分箱"(binning)的过程可以直观地查看数值的相对大小。统计每个观察点并将其放入不通的桶中，这样可以产生多个指标：每个桶一个，
加上所有值的总和以及计数。

直方图可以很好地展现时间序列数据，尤其适用于数据的可视化(如应用程序延迟等)。

关于直方图的更多信息请参考：https://prometheus.io/docs/practices/histograms/

还有另一种指标类型，称为“摘要型”（summary），类似于直方图，但它还会计算百分位数。

### 1.4.3 指标摘要

通常单个指标价值很小，往往需要联合并可视化多个指标。这其中需要应用一些数学变换。如将统计还书应用于指标或指标组，常见函数如下：

- 计数：计算特定时间间隔内的观察点数。
- 求和：将特定时间间隔内所有观察点的值累计相加。
- 求平均值：提供特定时间间隔内所有值的平均值。
- 中间数：数值的几何中点，正好50%的数值位于它的前面，而另外50%位于它后面。
- 百分位数：度量占总数特定百分比的观察点的值。
- 标准差：显示指标分布中与平均值的标准差，这可以测量出数据集的差异和程度。标准差为0表示数据都等于平局值，较高的标准差意味着数据分布的范围很广。
- 变化率：显示时间序列中数据之间的变化程度。

### 1.4.4 指标聚合

除指标摘要，你可能希望能看到来自多个源的指标的聚合试图。如所有应用服务器的磁盘空间使用情况。指标聚合最典型的样式就是在一张图上
显示多个指标，这有助于你识别环境的发展趋势。如负载均衡器中的间歇性故障可能导致多个服务器的web流量下降，这通常比通过查看每个单独的指标更容易发现。

#### 平均值

监控领域，高峰或低谷可能被平均值掩盖。这些隐藏的异常值可能意味着，当我们认为大多数用户都享受这高质量的服务体验时，实际上很可能
并非如此。如果我们仅依靠平均值，则可能会认为应用程序的性能比真实情况要好得多。

#### 中间数

中间数处在所有数值的正中心：正好50%的数值位于它的前面，另外50%位于它后面。如果有奇数项个值，则处于中间位置的值即为中间数。
对于数据集(12、22、15、3、7、94、39)来说，中间数为3.如果从数据集中删除39，则数据集有偶数个值，其中间数是中间两个值的平均
值，即中间数为9.

识别性能问题的另一种常用技术是根据平均值来计算指标的标准差。

#### 标准差

标准差衡量的是数据集的变化或分布。标准差为0表示大部分数据接近平均值，标准差越大意味着数据越分散。标准差由正或负加上sigma
符号表示，例如，1 sigma表示与平均值有一个标准差。

许多监控方法都会利用经验法则，当出现超过平均值两个标准差的事务或事件时出发警报，以捕获性能的异常值。如果数据不是正态分布的，
那么最终的并标准差可能会误导你。

#### 百分位数

百分位数度量的是占总数特定百分比的观察点的值。本质上讲，它会展示数据集的分布。对于指标而言，百分位数很有意义，因为它们可以
清洗地展现数值的分布。如，一个事务的99百分位数为10毫秒。这很容易理解：99%的事务在10毫秒或更短事件内完成，1%的事务处理时间
超过10毫秒。

**百分位数是识别异常值的理想选择**。如果响应时间小于10毫秒表示网站上的一个良好体验，那么99%的用户都是这样的——但其中1%但
用户没有。一旦意识到这一点，你就可以专注于解决造成那1%但性能问题。

然而，百分位数并不是完美但。建议绘制集中指标组合，以获得更清晰但数据图。例如，在测量延迟时，最好可以展示以下几项内容：

- 50百分位数(或中间数)
- 99百分位数
- 最大值

## 1.5 监控方法论

这里主要介绍两种监控方法：

- Brendan Gregg但USE(Utilization,Saturation,Error)方法，侧重主机级别监控
- Google但四个黄金指标，专注于应用程序级别监控。

### 1.5.1 USE方法

USE是使用率、饱和度和错误但缩写。由Netflix的内核和性能工程师Brendan Gregg开发。USE方法建议创建服务器分析清单，以便快速识别问题。

USE方法可以概括为：针对每个资源，检查使用率、饱和度和错误。该方法对于监控那些受高使用率或饱和度的性能问题影响的资源来说是最有
效的。让我们快速查看每个术语的定义以帮助理解。

- 资源：系统的一个组件。在Gregg对模型的定义中，它是一个传统意义上的物理服务器组件，如CPU、磁盘等，但许多人也将软件资源包含在定义中。
- 使用率：资源忙于工作的平均时间。它通常用随时间变化的百分比表示。
- 饱和度：资源排队工作的指标，无法再处理额外的工作。通常用队列长度表示
- 错误：资源错误事件的计数

可以查看Brendan Gregg提供的Linux系统的参考示例[清单](http://www.brendangregg.com/USEmethod/use-linux.html)

### 1.5.2 Google但四个黄金指标

Google的四个黄金指标来自Google SRE手册，采用与USE类似的方法，指定需要监控的通用指标类型。但此方法中的指标类型主要关注的不是
系统级别的时间序列数据，更多是针对应用程序或面向用户的部分：

- 延迟：服务请求所花费的时间，需要区分成功请求和失败请求。例如，失败请求可能会以非常低的延迟返回错误结果
- 流量：针对系统，例如，每秒HTTP请求数，或者数据库系统的事务
- 错误：请求失败的速率，要么是HTTP 500错误等显式失败，要么是返回错误内容或无效内容等隐式失败，或者基于策略原因导致的失败——例如，强制要求响应时间超过30ms的请求视为错误
- 饱和度：应用程序有多“满”，或者受限的资源，如内存或IO。这还包括即将饱和的部分，例如正在快速填充的磁盘

Weaveworks团队开发了一个名为RED（Rate、Error和Duration）的[相关框架](https://rancher.com/red-method-for-prometheus-3-key-metrics-for-monitoring)

# 2 Prometheus简介

## 2.1 Prometheus起源

Prometheus的灵感来自谷歌的Borgmon。最初由前Google SRE Matt T.Proud开发。在Proud加入SoundCloud后，他与另一位工程师Julius Volz
合作开发了Prometheus，并最终于2015年1月将其发布。

与Borgmon一样，Prometheus主要用于提供近实时的、基于动态云环境和容器的微服务、服务和应用程序的内省监控。

**Prometheus专注于现在正在发生的事情，而不是追踪数周或数月前的数据**。它基于这样一个前提，即大多数监控查询和警报都是从最近的（通常是一天内的）数据中生成的。Facebook在其内部时间序列数据库Gorilla的论文[插图]中验证了这一观点。Facebook发现85%的查询是针对26小时内的数据。Prometheus假定你尝试修复的问题可能是最近出现的，因此最有价值的是最近时间的数据，这反映在强大的查询语言和通常有限的监控数据保留期上。

## 2.2 Prometheus数据模型

Prometheus收集时间序列数据，它使用一个多维时间序列数据模型。这个时间序列模型结合了时间序列名称和标签(label)的键/值对，
这些标签提供了维度。每个时间序列由时间序列名称和标签的组合唯一 标识。

### 2.3.1 指标名称

