---
layout: post
title: TCP卷一之TCP笔记
date: 2020-08-15
author: tux
tags: TCP
---

# TCP Protocal

## 1 Introduction

### 1.1 TCP服务

#### 1.1.1 TCP服务特性：
- 面向连接：connection-oritented
- 可靠：reliable
- 字节流：bytes stream

#### 1.1.2 面向连接

意思是使用TCP通信的双方在进行数据交换前必须建立TCP连接

#### 1.1.3 可靠

TCP通过如下几个方面提供可靠的连接：
- 将应用数据分割为TCP认为合适大小的数据块进行传输。这与UDP不同。
- **定时器**。TCP在传输segment的时候会维护一个定时器，等待另一端对这个segment的接受确认。如果在规定的时间内没有确认接受，TCP将进行重传
- 接受数据后，会发送确认，但不会立即发送，而是延迟a fraction of second
- 对TCP的头部和数据进行校验和，如果到达的segment是个无效的校验和，TCP将丢弃segment并不进行确认
- **排序**.tcp segment是封装在ip datagram中的，而ip datagram的到达是无序的，tcp可以根据需要排序后发给上面的应用层
- **去重**.ip datagram会出现重复的数据包，tcp负责丢弃重复的数据
- flow control.TCP连接的双方都有一个有限的大小的缓冲区，当接收方的缓冲区被发送方发送的数据填满的时候，会暂停继续接受。

#### 1.1.4 byte stream service

TCP传输的是字节流，并不会对数据插入边界记录。比如，TCP连接的一段写了10个字节，接着又写了20个字节，然后又写了50个字节。对于接受端并不知道每次各写了多少字节，
他可能将这80个字节分四次读取，每次读取20字节。
其次TCP并不会对字节流数据进行解析，TCP并不知道字节流中的数据是二进制，还是ASCII或者其他。

### 1.2 TCP header

TCP首部，在没有options的情况下为20字节。TCP segment包含了源端口和目标端口，标识了发送和接受的应用。IP加端口有时称为`socket`。四元组定义一个TCP连接。

**sequence number**: sequence number标识了当前segment中由发送方到接受方的数据中第一个字节的位置。其为一个32位无符号整数，从0到2^32 - 1.
sequence number字段包含initial sequence number(ISN).ISN是host指定用于创建连接的，所以发送数据的第一个字节的sequence number应该是ISN + 1，因为SYN 标志位发送的时候消耗了
一个sequence number.同样在关闭连接的时候，FIN标志位的发送也会消耗一个sequence number.

发送ACK不需要消耗sequence number等任何东西，因为 acknowledgment number本省就是tcp header的一部分。因此连接一旦建立，ACK标志位是一直处于打开的状态。

TCP给应用层提供了全双工的服务，这意味着数据流动的双发是相互独立的，因此连接的双方都必须在每个数据流动方向上维护自己的数据顺序号。

**header length**字段给出了header的长度，以32-bit word为单位，是一个站4个bit的字段，因此，header的最大长度为4个bit位全位1的时候，即十进制数15，乘以其单位32-bit word(4个字节)，即
15 * 4 = 60 bytes。在没有option的时候，header正常大小是20bytes.

TCP header中有6个标志位：URG ACK PSH RST SYN FIN
URG: 需要发送方将紧急数据发给另一端
ACK:  acknowledgment number
PSH: 接受者需要尽快将数据发给应用层
RST：reset connection。**IP 冲突时会RST**
SYN：同步顺序号，建立连接
FIN：结束发送数据

checksum: TCP首部和TCP数据的校验和，强制字段
option字段：option字段通常为maximum segment size, MSS.连接双方通常会在第一个segment中指定这个选项，表明自己可以接受的MSS。

## 2 TCP connection establishment and termination

TCP是面向连接的协议，在发送数据前，双发必须先建立连接。

### 2.1 Connection Establishment and Termination

